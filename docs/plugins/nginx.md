# Nginx 日志分析插件

<p align="center">
  <img src="https://img.shields.io/badge/Plugin-Nginx-009639?style=flat&logo=nginx" alt="Nginx">
  <img src="https://img.shields.io/badge/Version-1.0.0-blue?style=flat" alt="Version">
  <img src="https://img.shields.io/badge/Status-Stable-green?style=flat" alt="Status">
</p>

---

## 概述

Nginx 日志分析插件提供全面的 Nginx 访问日志采集、分析和可视化功能。支持主机 Nginx数据源，提供实时流量监控、访客分析、地理位置统计、设备分析等功能，帮助运维团队深入了解网站访问情况。

---

## 功能特性

### 数据源管理

| 功能       | 描述 |
|:---------|:-----|
| 主机 Nginx | 通过 SSH 采集主机上的 Nginx 访问日志 |

### 概况统计

| 功能 | 描述 |
|:-----|:-----|
| 实时访客 | 显示当前在线访客数（5分钟内活跃） |
| 核心指标 | PV、UV、状态码分布、实时 QPS |
| 今昨对比 | 今日与昨日数据对比分析 |
| 趋势图表 | PV/UV 小时趋势和日趋势图 |
| 新老访客 | 新访客与回访访客比例分析 |

### Top 分析

| 功能 | 描述 |
|:-----|:-----|
| 来路排行 | Top 来源域名/Referer 统计 |
| 受访页面 | 访问量最高的页面排行 |
| 入口页面 | 用户首次访问的页面排行 |
| 地域分布 | 访客地理位置分布（国家/省份/城市） |
| 终端设备 | 浏览器、操作系统、设备类型分布 |

### 数据日报

| 功能 | 描述 |
|:-----|:-----|
| 日统计汇总 | 每日请求数、UV、带宽、响应时间 |
| 状态码分布 | 2xx/3xx/4xx/5xx 状态码统计 |
| 历史趋势 | 按日期范围查询历史数据 |
| 多数据源 | 支持按数据源筛选 |

### 访问明细

| 功能 | 描述 |
|:-----|:-----|
| 日志查询 | 支持多条件筛选访问日志 |
| 地理位置 | 显示访客 IP 的地理位置信息 |
| 设备信息 | UA 解析显示浏览器、OS、设备类型 |
| Top URI | 访问量最高的 URI 排行 |
| Top IP | 请求最多的 IP 排行 |

### 高级功能

| 功能 | 描述 |
|:-----|:-----|
| IP 地理位置解析 | 使用 GeoLite2 数据库解析 IP 地理位置 |
| User-Agent 解析 | 智能解析浏览器、操作系统、设备类型 |
| 数据聚合 | 自动生成小时/日聚合数据，提升查询性能 |
| 数据保留 | 可配置数据保留天数，自动清理过期数据 |

---

## 安装与启用

### 通过管理界面启用

1. 登录 OpsHub 系统
2. 进入「插件管理」-「插件列表」
3. 找到「Nginx」插件
4. 点击「启用」按钮
5. 刷新页面，左侧菜单出现「Nginx 统计」

### GeoIP 数据库

插件使用 MaxMind GeoLite2 数据库进行 IP 地理位置解析。Helm 部署时会自动下载，手动部署需要：

```bash
# 下载 GeoLite2-City 数据库
wget -O data/GeoLite2-City.mmdb https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-City.mmdb
```

---

## 使用指南

### 配置数据源

#### 添加主机 Nginx 数据源

1. 进入「Nginx 统计」-「数据源配置」
2. 点击「新增数据源」
3. 选择类型「主机 Nginx」
4. 填写配置：

| 字段 | 说明 |
|:-----|:-----|
| 名称 | 数据源名称（如：生产环境官网） |
| 关联主机 | 选择已添加的主机资产 |
| 日志路径 | Nginx 访问日志路径（如 `/var/log/nginx/access.log`） |
| 日志格式 | 日志格式类型（combined/json/custom） |
| 采集间隔 | 日志采集周期（默认 60 秒） |

5. 高级功能配置：
   - **地理位置解析**：启用后自动解析 IP 地理位置
   - **会话跟踪**：用于更精确的 UV 统计（开发中）

6. 点击「创建」


### 查看概况

1. 进入「Nginx 统计」-「概况」
2. 选择要查看的数据源
3. 页面展示：
   - **实时访客数**：5分钟内活跃的独立访客
   - **核心指标卡片**：今日 PV/UV、状态码分布、实时 QPS
   - **今昨对比**：与昨日同期数据对比
   - **趋势图表**：PV/UV 时间趋势
   - **新老访客**：新访客与回访访客比例
   - **来路/页面排行**：Top 10 来源和页面
   - **地域/终端分布**：访客分布饼图

### Top 分析

1. 进入「Nginx 统计」-「Top 分析」
2. 选择数据源和时间范围
3. 查看各维度的 Top 排行：
   - 受访页面 Top 10
   - 来源域名 Top 10
   - 访客 IP Top 10（含地理位置）
   - 搜索引擎来源统计

### 数据日报

1. 进入「Nginx 统计」-「数据日报」
2. 选择数据源和日期范围
3. 查看每日汇总数据表格：
   - 日期、请求数、UV、带宽
   - 平均响应时间
   - 各状态码数量

### 访问明细

1. 进入「Nginx 统计」-「访问明细」
2. 默认显示当天数据
3. 支持筛选条件：
   - 时间范围
   - 客户端 IP
   - 请求 URI
   - HTTP 状态码
   - 请求方法
4. 查看详细的访问日志，包含地理位置和设备信息

---

## 数据库表

Nginx 插件使用以下数据库表：

### 核心表

| 表名 | 说明 |
|:-----|:-----|
| `nginx_sources` | 数据源配置 |
| `nginx_access_logs` | 访问日志（扁平化存储） |

### 维度表（星型模型）

| 表名 | 说明 |
|:-----|:-----|
| `nginx_dim_ip` | IP 维度（含地理位置） |
| `nginx_dim_url` | URL 维度 |
| `nginx_dim_referer` | Referer 维度 |
| `nginx_dim_user_agent` | User-Agent 维度 |
| `nginx_fact_access_logs` | 访问日志事实表 |

### 聚合表

| 表名 | 说明 |
|:-----|:-----|
| `nginx_agg_hourly` | 小时聚合统计 |
| `nginx_agg_daily` | 日聚合统计 |

---

## 日志格式支持

### Combined 格式（默认）

```nginx
log_format combined '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent"';
```

### JSON 格式

```nginx
log_format json_combined escape=json '{'
  '"time_local":"$time_local",'
  '"remote_addr":"$remote_addr",'
  '"request":"$request",'
  '"status": "$status",'
  '"body_bytes_sent":"$body_bytes_sent",'
  '"request_time":"$request_time",'
  '"http_referer":"$http_referer",'
  '"http_user_agent":"$http_user_agent"'
'}';
```

### 自定义格式

支持通过正则表达式配置自定义日志格式解析。

---

## 性能优化

### 数据聚合

插件自动将原始日志数据聚合为小时和日维度的统计数据：

| 聚合类型 | 用途 | 优势 |
|:---------|:-----|:-----|
| 小时聚合 | 趋势图表、实时统计 | 查询快速，数据量小 |
| 日聚合 | 日报、历史分析 | 长期存储，节省空间 |

### 查询优化

| 优化措施 | 说明 |
|:---------|:-----|
| 复合索引 | source_id + timestamp 复合索引 |
| 分区查询 | 按时间范围限制查询范围 |
| 缓存 | LRU 缓存热点数据 |
| 并行加载 | 概况页各组件并行加载 |

### 数据清理

配置数据保留天数后，系统自动清理过期数据：

```yaml
# 数据源配置
retention_days: 30  # 保留 30 天数据
```

---

## 最佳实践

### 数据源配置

| 建议 | 说明 |
|:-----|:-----|
| 合理采集间隔 | 高流量站点建议 60 秒，低流量可设置更长 |
| 启用地理解析 | 需要地域分析时启用，会略微增加处理时间 |
| 日志格式匹配 | 确保配置的日志格式与实际 Nginx 配置一致 |

### 性能建议

| 建议 | 说明 |
|:-----|:-----|
| 数据保留 | 根据磁盘空间设置合理的保留天数 |
| 避免全表查询 | 访问明细查询时务必指定时间范围 |
| 定期清理 | 系统自动清理，无需手动干预 |

---

## 常见问题

### Q: 数据源状态显示错误？

**A:** 检查以下几点：
1. 主机是否可以 SSH 连接
2. 日志文件路径是否正确
3. 日志文件是否有读取权限
4. 查看数据源的「最后错误」信息

### Q: 地理位置显示"未知"？

**A:** 可能原因：
1. GeoLite2 数据库未下载或路径错误
2. IP 地址为内网地址（如 192.168.x.x）
3. IP 地址不在 GeoLite2 数据库中

### Q: 概况页加载缓慢？

**A:** 优化建议：
1. 确保数据库表有正确的索引
2. 检查是否有大量未聚合的原始数据
3. 适当减少数据保留天数

### Q: 日志解析失败？

**A:** 检查以下几点：
1. 日志格式配置是否与实际 Nginx 配置匹配
2. 日志文件编码是否为 UTF-8
3. 查看后端日志的详细错误信息



---

## 相关文档

- [Nginx 日志配置](https://nginx.org/en/docs/http/ngx_http_log_module.html)
- [GeoLite2 数据库](https://dev.maxmind.com/geoip/geolite2-free-geolocation-data)
- [OpsHub 主文档](../../README.md)
- [部署指南](../deployment.md)
