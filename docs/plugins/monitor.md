# Monitor 监控中心插件

<p align="center">
  <img src="https://img.shields.io/badge/Plugin-Monitor-4ECDC4?style=flat&logo=grafana" alt="Monitor">
  <img src="https://img.shields.io/badge/Version-1.0.0-blue?style=flat" alt="Version">
  <img src="https://img.shields.io/badge/Status-Stable-green?style=flat" alt="Status">
</p>

---

## 概述

Monitor 监控中心插件提供全面的域名监控、SSL 证书监控、告警管理功能，帮助运维团队及时发现和处理问题，保障业务稳定运行。

---

## 功能特性

### 域名监控

| 功能 | 描述 |
|:-----|:-----|
| SSL 证书监控 | 监控证书有效期、颁发者、加密算法 |
| 证书到期提醒 | 在证书过期前自动发送提醒 |
| 响应时间监控 | 监控域名的 HTTP 响应时间 |
| 批量管理 | 支持批量添加和管理域名 |
| 定时检查 | 可配置检查周期（默认每天） |

### 告警通道

| 功能 | 描述 |
|:-----|:-----|
| 邮件通知 | 支持 SMTP 邮件发送 |
| 钉钉通知 | 钉钉群机器人消息推送 |
| 企业微信 | 企业微信应用消息 |
| 飞书通知 | 飞书群机器人消息 |
| Webhook | 自定义 HTTP 回调 |

### 告警接收人

| 功能 | 描述 |
|:-----|:-----|
| 接收人管理 | 添加、编辑、删除告警接收人 |
| 多渠道配置 | 为接收人配置多个通知渠道 |
| 用户关联 | 关联系统用户自动获取联系方式 |

### 告警日志

| 功能 | 描述 |
|:-----|:-----|
| 发送记录 | 完整的告警发送记录 |
| 状态跟踪 | 跟踪告警发送成功/失败状态 |
| 历史查询 | 按时间、类型、状态筛选 |
| 统计分析 | 告警数量统计和趋势分析 |

---

## 安装与启用

### 通过管理界面启用

1. 登录 OpsHub 系统
2. 进入「插件管理」-「插件列表」
3. 找到「Monitor」插件
4. 点击「启用」按钮
5. 刷新页面，左侧菜单出现「监控中心」

### 通过 API 启用

```bash
# 启用插件
curl -X POST http://localhost:9876/api/v1/plugins/monitor/enable \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# 禁用插件
curl -X POST http://localhost:9876/api/v1/plugins/monitor/disable \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

---

## 使用指南

### 域名监控

#### 添加监控域名

1. 进入「监控中心」-「域名监控」
2. 点击「添加域名」按钮
3. 填写域名信息：

| 字段 | 说明 |
|:-----|:-----|
| 域名/URL | 要监控的域名（如 `example.com`） |
| 检查间隔 | 检查周期（默认 86400 秒/天） |
| 启用 SSL | 是否检查 SSL 证书 |
| 启用告警 | 是否开启告警通知 |
| 响应阈值 | 响应时间超过此值触发告警 |
| 过期天数 | 证书过期前多少天告警 |

4. 点击「保存」
5. 系统自动获取证书信息

#### 查看证书详情

点击域名列表中的域名，可以查看：

| 信息 | 说明 |
|:-----|:-----|
| 颁发者 | 证书颁发机构（CA） |
| 主体 | 证书绑定的域名 |
| 有效期 | 证书生效和过期日期 |
| 算法 | 使用的加密算法 |
| 序列号 | 证书唯一序列号 |
| 指纹 | SHA256 指纹 |

#### 证书到期提醒

系统会根据配置自动发送提醒：

| 提醒时间 | 告警级别 |
|:---------|:---------|
| 过期前 30 天 | 低 |
| 过期前 7 天 | 中 |
| 过期前 3 天 | 高 |
| 过期前 1 天 | 紧急 |

### 配置告警通道

#### 邮件通道

1. 进入「监控中心」-「告警通道」
2. 点击「新建通道」，选择「邮件」
3. 配置 SMTP 参数：

```yaml
通道名称: 公司邮箱
SMTP 服务器: smtp.company.com
SMTP 端口: 587
发送人邮箱: alert@company.com
邮箱密码: your-password
加密方式: STARTTLS
```

4. 点击「测试」验证配置
5. 点击「保存」

#### 钉钉通道

1. 选择「钉钉」通道类型
2. 创建钉钉群机器人，获取 Webhook URL
3. 配置参数：

```yaml
通道名称: 运维告警群
Webhook URL: https://oapi.dingtalk.com/robot/send?access_token=xxx
安全设置: 关键字/加签（根据机器人配置）
```

4. 测试并保存

#### 企业微信通道

1. 选择「企业微信」通道类型
2. 创建企业微信应用
3. 配置参数：

```yaml
通道名称: 企微告警
企业 ID: ww123456789
应用 ID: 1000001
应用密钥: xxxxx
接收者: @all 或 用户ID|部门ID
```

4. 测试并保存

#### 飞书通道

1. 选择「飞书」通道类型
2. 创建飞书群机器人
3. 配置 Webhook URL
4. 测试并保存

#### Webhook 通道

1. 选择「Webhook」通道类型
2. 配置回调地址：

```yaml
通道名称: 自定义回调
URL: https://your-server.com/webhook/alert
请求方法: POST
请求头:
  Content-Type: application/json
  Authorization: Bearer xxx
```

3. 保存后，告警会以 JSON 格式发送：

```json
{
  "alert_id": "123456",
  "alert_type": "ssl_expiry",
  "domain": "example.com",
  "message": "SSL 证书将在 7 天后过期",
  "level": "warning",
  "timestamp": "2024-01-26T10:30:00Z"
}
```

### 管理告警接收人

#### 添加接收人

1. 进入「监控中心」-「告警接收人」
2. 点击「添加接收人」
3. 填写接收人信息：

| 字段 | 说明 |
|:-----|:-----|
| 名称 | 接收人显示名称 |
| 邮箱 | 邮件通知地址 |
| 电话 | 短信通知号码 |
| 启用通道 | 选择接收哪些渠道的通知 |

4. 保存

#### 关联系统用户

如果接收人是系统用户，可以直接关联用户，自动获取联系方式。

### 查看告警日志

1. 进入「监控中心」-「告警日志」
2. 筛选条件：
   - 时间范围
   - 告警类型
   - 发送状态
   - 域名
3. 查看发送详情和错误信息

---

## 数据库表

Monitor 插件使用以下数据库表：

| 表名 | 说明 |
|:-----|:-----|
| `domain_monitors` | 域名监控配置 |
| `alert_configs` | 告警配置 |
| `alert_channels` | 告警通道 |
| `alert_receivers` | 告警接收人 |
| `alert_receiver_channels` | 接收人-通道关联 |
| `alert_logs` | 告警发送日志 |

---

## 监控指标

### SSL 证书指标

| 指标 | 说明 | 告警建议 |
|:-----|:-----|:---------|
| 证书有效期 | 距离过期的天数 | < 30 天告警 |
| SSL 版本 | TLS 版本 | TLS 1.2+ |
| 加密算法 | 使用的加密套件 | 避免弱加密 |
| 证书链 | 证书链完整性 | 确保完整 |

### 域名可用性指标

| 指标 | 说明 | 告警建议 |
|:-----|:-----|:---------|
| 响应时间 | HTTP 请求响应时间 | > 1000ms 告警 |
| 状态码 | HTTP 响应状态 | 非 2xx 告警 |
| 可用率 | 检查成功率 | < 99% 告警 |

---

## 告警规则

### 告警级别

| 级别 | 说明 | 处理时限 |
|:-----|:-----|:---------|
| **紧急** | 服务已中断或证书即将过期 | 立即处理 |
| **高** | 服务性能严重下降 | 30 分钟内 |
| **中** | 服务性能略有下降 | 2 小时内 |
| **低** | 一般性提醒 | 当天内 |

### 告警防抖

避免同一告警重复发送：

| 配置项 | 说明 | 建议值 |
|:-------|:-----|:-------|
| 静默时间 | 同一告警的静默间隔 | 30 分钟 |
| 恢复通知 | 问题恢复后是否通知 | 开启 |

---

## 最佳实践

### 监控策略

| 建议 | 说明 |
|:-----|:-----|
| 分级监控 | 根据业务重要性设置不同的监控级别 |
| 合理告警 | 避免过于敏感的告警，防止告警疲劳 |
| 多渠道 | 紧急告警配置多个通知渠道 |
| 定期审查 | 定期审查监控项和告警规则 |

### 证书管理

| 建议 | 说明 |
|:-----|:-----|
| 提前更新 | 在过期前 30 天开始准备更新 |
| 自动续期 | 使用 Let's Encrypt 等支持自动续期的证书 |
| 备份证书 | 保存重要证书的备份 |
| 监控子域名 | 不要遗漏子域名的证书监控 |

### 告警配置

| 建议 | 说明 |
|:-----|:-----|
| 明确责任人 | 每个监控项有明确的告警接收人 |
| 分时段 | 根据工作时间配置不同的告警策略 |
| 升级机制 | 配置告警升级，问题未解决时通知上级 |
| 测试验证 | 定期测试告警通道是否正常 |

---

## 常见问题

### Q: 为什么没有收到告警通知？

**A:** 检查以下几点：
1. 监控项是否启用了告警
2. 告警通道配置是否正确
3. 接收人是否关联了通道
4. 查看告警日志中的错误信息
5. 检查邮件垃圾箱

### Q: 如何手动触发证书检查？

**A:** 在域名监控列表中，点击「立即检查」按钮可以手动触发检查。

### Q: 证书信息显示不正确？

**A:** 可能原因：
1. 域名 DNS 解析问题
2. 网络无法访问目标域名
3. 目标服务器配置了多个证书

点击「刷新」按钮重新获取证书信息。

### Q: 如何批量导入域名？

**A:** 目前支持：
1. 通过 API 批量创建
2. 使用 CSV 文件导入（开发中）

### Q: 告警发送太频繁怎么办？

**A:** 调整告警配置：
1. 增加告警间隔时间
2. 调整告警阈值
3. 启用告警静默

---

## 相关文档

- [SSL/TLS 最佳实践](https://wiki.mozilla.org/Security/Server_Side_TLS)
- [Let's Encrypt 文档](https://letsencrypt.org/docs/)
- [钉钉机器人开发](https://open.dingtalk.com/document/robots/custom-robot-access)
- [企业微信 API](https://developer.work.weixin.qq.com/document/)
- [OpsHub 主文档](../../README.md)
- [部署指南](../deployment.md)
